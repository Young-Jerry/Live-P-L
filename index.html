<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stock Live Tracker - API/CFCL/CLI</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: #0b1320;
      color: #d0d7e0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .container {
      width: 280px;
      background: #1b2735;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 700;
      margin-bottom: 10px;
    }
    .timer {
      background: #0e1824;
      color: #3bcf81;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 13px;
    }
    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      background: #0e1824;
      border-radius: 8px;
      padding: 10px;
      gap: 8px;
    }
    .stat {
      display: flex;
      flex-direction: column;
    }
    .stat .label {
      font-size: 12px;
      color: #9aa4b4;
    }
    .stat .value {
      font-size: 14px;
      font-weight: 700;
      margin-top: 3px;
    }
    .profit {
      color: #e8505b;
    }
    .capital {
      color: #ffffff;
    }
    .bullish {
      color: #3bcf81;
    }
    .bearish {
      color: #e8505b;
    }
    .chart-box {
      background: #0e1824;
      border-radius: 8px;
      margin-top: 10px;
      height: 150px;
      padding: 6px;
    }
    canvas {
      width: 100%;
      height: 100%;
    }
    .stock-list {
      margin-top: 10px;
      background: transparent;
      border-radius: 6px;
      padding: 6px;
      font-size: 13px;
    }
    .stock-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .stock-symbol {
      font-weight: 700;
    }
    .stock-price {
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">ðŸ“ˆ Live Stocks <span id="timer" class="timer">5s</span></div>

    <div class="stats">
      <div class="stat">
        <div class="label">Profit (Net)</div>
        <div class="value profit" id="profit">â‚¹0.00</div>
      </div>
      <div class="stat">
        <div class="label">Bullish Stocks</div>
        <div class="value bullish" id="bullish">0</div>
      </div>
      <div class="stat">
        <div class="label">Capital</div>
        <div class="value capital" id="capital">â‚¹0.00</div>
      </div>
      <div class="stat">
        <div class="label">Bearish Stocks</div>
        <div class="value bearish" id="bearish">0</div>
      </div>
    </div>

    <div class="chart-box"><canvas id="chart"></canvas></div>
    <div class="stock-list" id="stockList"></div>
  </div>

  <script>
    const TICK = 5000; // 5 secs
    const HIST_LEN = 60;

const initialStocks = [
  { symbol: 'API', shares: 360, buyPrice: 108415.872 / 360 }, // â‰ˆ 301.1552
  { symbol: 'CFCL', shares: 27, buyPrice: 100 },
  { symbol: 'CLI', shares: 13, buyPrice: 2740 / 13 },         // â‰ˆ 210.7692
  { symbol: 'GHL', shares: 90, buyPrice: 100 },
  { symbol: 'HBL', shares: 10, buyPrice: 157 },
  { symbol: 'HIDCL', shares: 72, buyPrice: 100 },
  { symbol: 'HLI', shares: 12, buyPrice: 100 },
  { symbol: 'HPPL', shares: 10, buyPrice: 100 },
  { symbol: 'ILI', shares: 12, buyPrice: 2569.1 / 12 },        // â‰ˆ 214.0917
  { symbol: 'JBBL', shares: 19, buyPrice: 100 },
  { symbol: 'LUK', shares: 500, buyPrice: 10 },
  { symbol: 'MBJC', shares: 10, buyPrice: 100 },
  { symbol: 'NADEP', shares: 30, buyPrice: 100 },
  { symbol: 'NGPL', shares: 93, buyPrice: 100 },
  { symbol: 'NIFRA', shares: 54, buyPrice: 100 },
  { symbol: 'NIMB', shares: 125, buyPrice: 100 },
  { symbol: 'NMB', shares: 74, buyPrice: 100 },
  { symbol: 'NRN', shares: 11, buyPrice: 100 },
  { symbol: 'RHPL', shares: 40, buyPrice: 100 },
  { symbol: 'RNLI', shares: 12, buyPrice: 2770 / 12 },         // â‰ˆ 230.8333
  { symbol: 'SCB', shares: 25, buyPrice: 576 },
  { symbol: 'SGIC', shares: 10, buyPrice: 100 },
  { symbol: 'SJCL', shares: 20, buyPrice: 100 },
  { symbol: 'SNLI', shares: 16, buyPrice: 186.875 },
  { symbol: 'SSIS', shares: 93, buyPrice: 10 },
  { symbol: 'UAIL', shares: 10, buyPrice: 100 }
];


    let stocks = JSON.parse(localStorage.getItem('stocks') || 'null');
    if (!stocks) {
      stocks = initialStocks.map(s => ({ ...s, price: s.buyPrice }));
      localStorage.setItem('stocks', JSON.stringify(stocks));
    }

    const profitEl = document.getElementById('profit');
    const capitalEl = document.getElementById('capital');
    const bullishEl = document.getElementById('bullish');
    const bearishEl = document.getElementById('bearish');
    const stockListEl = document.getElementById('stockList');
    const timerEl = document.getElementById('timer');

    const ctx = document.getElementById('chart').getContext('2d');
    const chartData = Array(HIST_LEN).fill(0);
    const config = {
      type: 'line',
      data: {
        labels: Array.from({ length: HIST_LEN }, (_, i) => i + 1),
        datasets: [{
          label: 'Net Profit',
          data: chartData,
          borderColor: '#ff2d55',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.5,
          fill: false,
          segment: {
            borderColor: ctx => {
              const p0 = ctx.p0.parsed.y;
              const p1 = ctx.p1.parsed.y;
              const mid = (p0 + p1) / 2;
              return mid >= 0 ? '#3bcf81' : '#ff2d55';
            }
          }
        }]
      },
      options: {
        animation: { duration: 600, easing: 'easeOutQuad' },
        responsive: true,
        maintainAspectRatio: false,
        scales: { x: { display: false }, y: { display: false } },
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            callbacks: {
              label: ctx => {
                const val = ctx.parsed.y;
                const prefix = val >= 0 ? 'Profit: â‚¹' : 'Loss: -â‚¹';
                return prefix + Math.abs(val).toFixed(2);
              }
            },
            backgroundColor: '#1b2735',
            titleColor: '#fff',
            bodyColor: '#3bcf81',
            borderColor: '#3bcf81',
            borderWidth: 1,
            padding: 8
          }
        }
      }
    };
    const myChart = new Chart(ctx, config);

    function renderStockList() {
      stockListEl.innerHTML = '';
      stocks.forEach(s => {
        const div = document.createElement('div');
        div.className = 'stock-item';
        div.innerHTML = `<div><span class="stock-symbol">${s.symbol}</span> &nbsp;<span style="opacity:0.7">x${s.shares}</span></div><div class="stock-price">â‚¹${s.price.toFixed(2)}</div>`;
        stockListEl.appendChild(div);
      });
    }

    function computeMetrics() {
      const totalMarket = stocks.reduce((sum, s) => sum + s.price * s.shares, 0);
      const totalCost = stocks.reduce((sum, s) => sum + s.buyPrice * s.shares, 0);
      const netProfit = totalMarket - totalCost;
      const bullish = stocks.filter(s => s.price > s.buyPrice).length;
      const bearish = stocks.filter(s => s.price < s.buyPrice).length;
      return { totalMarket, totalCost, netProfit, bullish, bearish };
    }

    function updateUI(metrics) {
      profitEl.innerText = (metrics.netProfit >= 0 ? 'â‚¹' : '-â‚¹') + Math.abs(metrics.netProfit).toFixed(2);
      capitalEl.innerText = 'â‚¹' + metrics.totalMarket.toFixed(2);
      bullishEl.innerText = metrics.bullish;
      bearishEl.innerText = metrics.bearish;
    }

    function pushChartValue(val) {
      const data = myChart.data.datasets[0].data;
      data.push(+val.toFixed(2));
      if (data.length > HIST_LEN) data.shift();
      const mx = Math.max(...data.map(Math.abs));
      const pad = Math.max(50, mx * 1.1);
      myChart.options.scales.y.min = -pad;
      myChart.options.scales.y.max = pad;
      myChart.update();
    }

    async function fetchPricesFromAPI() {
      const symbols = stocks.map(s => s.symbol);
      const proxyUrl = 'https://corsproxy.io/?'; // <-- CORS proxy here
      console.log('â†’ fetchPricesFromAPI() called at', new Date().toLocaleTimeString());

      try {
        const results = await Promise.all(symbols.map(async symbol => {
          const url = `${proxyUrl}https://nepsetty.kokomo.workers.dev/api/stock?symbol=${symbol}`;
          console.log('Fetching URL:', url);
          const res = await fetch(url);
          console.log('Response status for', symbol, res.status);
          const data = await res.json();
          console.log('Data for', symbol, data);
          return { symbol, price: data.ltp };
        }));

        results.forEach(np => {
          if (np.price != null) {
            const s = stocks.find(x => x.symbol === np.symbol);
            if (s) {
              console.log(`Updating ${np.symbol}: ${s.price} â†’ ${np.price}`);
              s.price = +np.price;
            }
          }
        });

        console.log('Stocks after update:', stocks);
        localStorage.setItem('stocks', JSON.stringify(stocks));
        renderStockList();
        const metrics = computeMetrics();
        updateUI(metrics);
        pushChartValue(metrics.netProfit);

      } catch (err) {
        console.error('Error in fetchPricesFromAPI:', err);
      }
    }

    renderStockList();
    updateUI(computeMetrics());
    pushChartValue(computeMetrics().netProfit);

    let sec = TICK / 1000;
    setInterval(() => {
      sec--;
      if (sec <= 0) {
        fetchPricesFromAPI();
        sec = TICK / 1000;
      }
      timerEl.innerText = sec + 's';
    }, 1000);

    window.fetchAndApplyPrices = function(newPrices) {
      newPrices.forEach(np => {
        const s = stocks.find(x => x.symbol === np.symbol);
        if (s) s.price = +np.price;
      });
      localStorage.setItem('stocks', JSON.stringify(stocks));
      renderStockList();
      const metrics = computeMetrics();
      updateUI(metrics);
      pushChartValue(metrics.netProfit);
    };
  </script>
</body>
</html>
