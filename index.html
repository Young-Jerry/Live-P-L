<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Stock Tracker - Today's Profit</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ... (your existing CSS unchanged) ... */
  </style>
</head>
<body>
  <div class="container">
    <div class="left-panel">
      <div class="header">
        ðŸ“ˆ Live Stocks <span id="timer" class="timer">5s</span>
      </div>
      <div class="stats">
        <div class="stat">
          <div class="label">Capital (Market Value)</div>
          <div class="value capital" id="capital">â‚¹0.00</div>
        </div>
        <div class="stat">
          <div class="label">Total Profit</div>
          <div class="value" id="totalProfit">â‚¹0.00</div>
        </div>
        <div class="stat profit" id="todayProfit">â‚¹0.00</div>
      </div>
      <div class="chart-box"><canvas id="chart"></canvas></div>
    </div>

    <div class="right-panel">
      <div class="stock-list" id="stockList"></div>
    </div>
  </div>

<script>
  const TICK = 5000;
  const HIST_LEN = 60;

  const initialStocks = [
    { symbol: 'API', shares: 360, buyPrice: 108415.872 / 360 },
    { symbol: 'CFCL', shares: 27, buyPrice: 100 },
    { symbol: 'CLI', shares: 13, buyPrice: 2740 / 13 },
    { symbol: 'GHL', shares: 90, buyPrice: 100 },
    { symbol: 'HBL', shares: 10, buyPrice: 157 },
    { symbol: 'HIDCL', shares: 72, buyPrice: 100 },
    { symbol: 'HLI', shares: 12, buyPrice: 100 },
    { symbol: 'HPPL', shares: 10, buyPrice: 100 },
    { symbol: 'ILI', shares: 12, buyPrice: 2569.1 / 12 },
    { symbol: 'JBBL', shares: 19, buyPrice: 100 },
    { symbol: 'LUK', shares: 500, buyPrice: 10 },
    { symbol: 'MBJC', shares: 10, buyPrice: 100 },
    { symbol: 'NADEP', shares: 30, buyPrice: 100 },
    { symbol: 'NGPL', shares: 93, buyPrice: 100 },
    { symbol: 'NIFRA', shares: 54, buyPrice: 100 },
    { symbol: 'NIMB', shares: 125, buyPrice: 100 },
    { symbol: 'NMB', shares: 74, buyPrice: 100 },
    { symbol: 'NRN', shares: 11, buyPrice: 100 },
    { symbol: 'RHPL', shares: 40, buyPrice: 100 },
    { symbol: 'RNLI', shares: 12, buyPrice: 2770 / 12 },
    { symbol: 'SCB', shares: 25, buyPrice: 576 },
    { symbol: 'SGIC', shares: 10, buyPrice: 100 },
    { symbol: 'SJCL', shares: 20, buyPrice: 100 },
    { symbol: 'SNLI', shares: 16, buyPrice: 186.875 },
    { symbol: 'SSIS', shares: 93, buyPrice: 10 },
    { symbol: 'UAIL', shares: 10, buyPrice: 100 }
  ];

  let stocks = initialStocks.map(s => ({ ...s, price: s.buyPrice }));

  // Elements
  const profitEl = document.getElementById('todayProfit');
  const totalProfitEl = document.getElementById('totalProfit');
  const capitalEl = document.getElementById('capital');
  const stockListEl = document.getElementById('stockList');
  const timerEl = document.getElementById('timer');
  const ctx = document.getElementById('chart').getContext('2d');

  const chartData = Array(HIST_LEN).fill(0);

  const config = {
    type: 'line',
    data: {
      labels: Array.from({ length: HIST_LEN }, (_, i) => i + 1),
      datasets: [{
        label: "Today's Profit",
        data: chartData,
        borderColor: '#3bcf81',
        borderWidth: 2,
        pointRadius: 0,
        tension: 0.5,
        fill: false,
        segment: {
          borderColor: ctx => {
            const p0 = ctx.p0.parsed.y;
            const p1 = ctx.p1.parsed.y;
            const mid = (p0 + p1) / 2;
            return mid >= 0 ? '#3bcf81' : '#ff2d55';
          }
        }
      }]
    },
    options: {
      animation: { duration: 600, easing: 'easeOutQuad' },
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { display: false },
        y: { display: false }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          enabled: true,
          callbacks: {
            label: ctx => {
              const val = ctx.parsed.y;
              const prefix = val >= 0 ? 'Profit: â‚¹' : 'Loss: -â‚¹';
              return prefix + Math.abs(val).toFixed(2);
            }
          },
          backgroundColor: '#1b2735',
          titleColor: '#fff',
          bodyColor: '#3bcf81',
          borderColor: '#3bcf81',
          borderWidth: 1,
          padding: 8
        }
      }
    }
  };

  const myChart = new Chart(ctx, config);

  function renderStockList() {
    stockListEl.innerHTML = '';
    stocks.forEach(s => {
      const div = document.createElement('div');
      div.className = 'stock-item';
      div.innerHTML = `
        <div>
          <span class="stock-symbol">${s.symbol}</span> &nbsp;
          <span style="opacity:0.7">x${s.shares}</span>
        </div>
        <div class="stock-price">â‚¹${s.price.toFixed(2)}</div>
      `;
      stockListEl.appendChild(div);
    });
  }

  // Calculate profits and total market cap
  function computeMetrics(dailyPrices) {
    let totalMarket = 0;
    let todayProfit = 0;
    let totalProfit = 0;

    stocks.forEach(s => {
      const yesterdayPrice = dailyPrices[s.symbol] ?? s.buyPrice;
      totalMarket += s.price * s.shares;
      todayProfit += (s.price - yesterdayPrice) * s.shares;
      totalProfit += (s.price - s.buyPrice) * s.shares;
    });

    return { totalMarket, todayProfit, totalProfit };
  }

  function updateUI(metrics) {
    profitEl.innerText = (metrics.todayProfit >= 0 ? 'â‚¹' : '-â‚¹') + Math.abs(metrics.todayProfit).toFixed(2);
    totalProfitEl.innerText = (metrics.totalProfit >= 0 ? 'â‚¹' : '-â‚¹') + Math.abs(metrics.totalProfit).toFixed(2);
    capitalEl.innerText = 'â‚¹' + metrics.totalMarket.toFixed(2);
  }

  function pushChartValue(val) {
    const data = myChart.data.datasets[0].data;
    data.push(+val.toFixed(2));
    if (data.length > HIST_LEN) data.shift();
    const maxVal = Math.max(...data.map(Math.abs));
    const pad = Math.max(50, maxVal * 1.1);
    myChart.options.scales.y.min = -pad;
    myChart.options.scales.y.max = pad;
    myChart.update();
  }

  // Fetch yesterday's prices JSON from your hosted daily_prices.json
  async function fetchYesterdayPrices() {
    const url = 'https://yourdomain.com/path/to/daily_prices.json'; // <-- CHANGE THIS URL to your hosted JSON file
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error('Failed to fetch yesterday prices');
      return await res.json();
    } catch (err) {
      console.error('Error fetching yesterday prices:', err);
      return {};
    }
  }

  // Fetch live prices from API
  async function fetchLivePrices() {
    const symbols = stocks.map(s => s.symbol);
    const proxyUrl = 'https://corsproxy.io/?'; // CORS proxy if needed

    try {
      const results = await Promise.all(symbols.map(async symbol => {
        const url = `${proxyUrl}https://nepsetty.kokomo.workers.dev/api/stock?symbol=${symbol}`;
        const res = await fetch(url);
        const data = await res.json();
        return { symbol, price: data.ltp };
      }));

      results.forEach(np => {
        if (np.price != null) {
          const s = stocks.find(x => x.symbol === np.symbol);
          if (s) s.price = +np.price;
        }
      });

      renderStockList();

      const dailyPrices = await fetchYesterdayPrices();
      const metrics = computeMetrics(dailyPrices);
      updateUI(metrics);
      pushChartValue(metrics.todayProfit);

    } catch (err) {
      console.error('Fetch error:', err);
    }
  }

  renderStockList();
  fetchLivePrices();

  let sec = TICK / 1000;
  setInterval(() => {
    sec--;
    if (sec <= 0) {
      fetchLivePrices();
      sec = TICK / 1000;
    }
    timerEl.innerText = sec + 's';
  }, 1000);

</script>
</body>
</html>
