<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Live Stock Tracker - Profit Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    margin: 0;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    background: #0b1320;
    color: #d0d7e0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }
  .container {
    display: flex;
    flex-direction: row;
    gap: 20px;
    background: transparent;
    padding: 20px;
    border-radius: 10px;
    width: 100%;
    max-width: 900px;
  }
  .left-panel {
    flex: 1.5;
    background: #1b2735;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
  }
  .right-panel {
    flex: 1;
    background: #1b2735;
    border-radius: 10px;
    padding: 15px;
    max-height: 500px;
    overflow-y: auto;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
  }
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 700;
    margin-bottom: 10px;
  }
  .timer {
    background: #0e1824;
    color: #3bcf81;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 13px;
  }
  .stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    background: #0e1824;
    border-radius: 8px;
    padding: 10px;
    gap: 8px;
    margin-bottom: 10px;
  }
  .stat {
    display: flex;
    flex-direction: column;
    text-align: center;
  }
  .stat .label {
    font-size: 12px;
    color: #9aa4b4;
  }
  .stat .value {
    font-size: 18px;
    font-weight: 700;
    margin-top: 3px;
  }
  .profit {
    color: #3bcf81;
  }
  .capital {
    color: #ffffff;
  }
  .chart-box {
    background: #0e1824;
    border-radius: 8px;
    height: 200px;
    padding: 6px;
  }
  canvas {
    width: 100%;
    height: 100%;
  }
  .stock-list {
    font-size: 13px;
  }
  .stock-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
  }
  .stock-symbol {
    font-weight: 700;
  }
  .stock-price {
    opacity: 0.9;
  }
  @media (max-width: 768px) {
    body {
      align-items: flex-start;
      padding: 10px;
      height: auto;
    }
    .container {
      flex-direction: column;
    }
    .left-panel, .right-panel {
      width: 100%;
    }
  }
</style>
</head>
<body>
<div class="container">
  <div class="left-panel">
    <div class="header">
      ðŸ“ˆ Live Stocks <span id="time" class="timer"></span>
    </div>
    <div class="stats">
      <div class="stat">
        <div class="label">Capital</div>
        <div class="value capital" id="capital">â‚¹0.00</div>
      </div>
      <div class="stat">
        <div class="label">Total Profit</div>
        <div class="value profit" id="totalProfit">â‚¹0.00</div>
      </div>
      <div class="stat">
        <div class="label">Today's Profit</div>
        <div class="value profit" id="todayProfit">â‚¹0.00</div>
      </div>
    </div>
    <div class="chart-box"><canvas id="chart"></canvas></div>
  </div>
  <div class="right-panel">
    <div class="stock-list" id="stockList"></div>
  </div>
</div>

<script>
  const TICK = 5000;
  const HIST_LEN = 60;

  const initialStocks = [
    { symbol: 'API', shares: 360, buyPrice: 108415.872 / 360 },
    { symbol: 'CFCL', shares: 27, buyPrice: 100 },
    { symbol: 'CLI', shares: 13, buyPrice: 2740 / 13 },
    { symbol: 'GHL', shares: 90, buyPrice: 100 },
    { symbol: 'HBL', shares: 10, buyPrice: 157 },
    { symbol: 'HIDCL', shares: 72, buyPrice: 100 },
    { symbol: 'HLI', shares: 12, buyPrice: 100 },
    { symbol: 'HPPL', shares: 10, buyPrice: 100 },
    { symbol: 'ILI', shares: 12, buyPrice: 2569.1 / 12 },
    { symbol: 'JBBL', shares: 19, buyPrice: 100 },
    { symbol: 'LUK', shares: 500, buyPrice: 10 },
    { symbol: 'MBJC', shares: 10, buyPrice: 100 },
    { symbol: 'NADEP', shares: 30, buyPrice: 100 },
    { symbol: 'NGPL', shares: 93, buyPrice: 100 },
    { symbol: 'NIFRA', shares: 54, buyPrice: 100 },
    { symbol: 'NIMB', shares: 125, buyPrice: 100 },
    { symbol: 'NMB', shares: 74, buyPrice: 100 },
    { symbol: 'NRN', shares: 11, buyPrice: 100 },
    { symbol: 'RHPL', shares: 40, buyPrice: 100 },
    { symbol: 'RNLI', shares: 12, buyPrice: 2770 / 12 },
    { symbol: 'SCB', shares: 25, buyPrice: 576 },
    { symbol: 'SGIC', shares: 10, buyPrice: 100 },
    { symbol: 'SJCL', shares: 20, buyPrice: 100 },
    { symbol: 'SNLI', shares: 16, buyPrice: 186.875 },
    { symbol: 'SSIS', shares: 93, buyPrice: 10 },
    { symbol: 'UAIL', shares: 10, buyPrice: 100 }
  ];

  let stocks = initialStocks.map(s => ({ ...s, price: s.buyPrice }));

  const profitEl = document.getElementById('todayProfit');
  const totalProfitEl = document.getElementById('totalProfit');
  const capitalEl = document.getElementById('capital');
  const stockListEl = document.getElementById('stockList');
  const timeEl = document.getElementById('time');
  const ctx = document.getElementById('chart').getContext('2d');

  const chartData = Array(HIST_LEN).fill(0);

  const myChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: Array.from({ length: HIST_LEN }, (_, i) => i + 1),
      datasets: [{
        label: "Today's Profit",
        data: chartData,
        borderColor: '#3bcf81',
        borderWidth: 2,
        pointRadius: 0,
        tension: 0.5,
        fill: false
      }]
    },
    options: {
      animation: { duration: 600, easing: 'easeOutQuad' },
      responsive: true,
      maintainAspectRatio: false,
      scales: { x: { display: false }, y: { display: false } },
      plugins: {
        legend: { display: false },
        tooltip: {
          enabled: true,
          callbacks: {
            label: ctx => {
              const val = ctx.parsed.y;
              const prefix = val >= 0 ? 'Profit: â‚¹' : 'Loss: -â‚¹';
              return prefix + Math.abs(val).toFixed(2);
            }
          },
          backgroundColor: '#1b2735',
          titleColor: '#fff',
          bodyColor: '#3bcf81',
          borderColor: '#3bcf81',
          borderWidth: 1,
          padding: 8
        }
      }
    }
  });

  function renderStockList() {
    stockListEl.innerHTML = '';
    stocks.forEach(s => {
      const div = document.createElement('div');
      div.className = 'stock-item';
      div.innerHTML = `
        <div>
          <span class="stock-symbol">${s.symbol}</span> &nbsp; <span style="opacity:0.7">x${s.shares}</span>
        </div>
        <div class="stock-price">â‚¹${s.price.toFixed(2)}</div>
      `;
      stockListEl.appendChild(div);
    });
  }

  function computeMetrics(dailyPrices) {
    const totalMarket = stocks.reduce((sum, s) => sum + s.price * s.shares, 0);
    const totalProfit = stocks.reduce((sum, s) => sum + (s.price - s.buyPrice) * s.shares, 0);
    const todayProfit = stocks.reduce((sum, s) => {
      const yesterdayPrice = dailyPrices[s.symbol] ?? s.buyPrice;
      return sum + (s.price - yesterdayPrice) * s.shares;
    }, 0);
    return { totalMarket, totalProfit, todayProfit };
  }

  function updateUI(metrics) {
    totalProfitEl.innerText = (metrics.totalProfit >= 0 ? 'â‚¹' : '-â‚¹') + Math.abs(metrics.totalProfit).toFixed(2);
    profitEl.innerText = (metrics.todayProfit >= 0 ? 'â‚¹' : '-â‚¹') + Math.abs(metrics.todayProfit).toFixed(2);
    capitalEl.innerText = 'â‚¹' + metrics.totalMarket.toFixed(2);
  }

  function pushChartValue(val) {
    const data = myChart.data.datasets[0].data;
    data.push(+val.toFixed(2));
    if (data.length > HIST_LEN) data.shift();
    myChart.update();
  }

  async function fetchYesterdayPrices() {
    try {
      const res = await fetch('./daily_prices.json');
      if (!res.ok) throw new Error('Failed to fetch yesterday prices');
      return await res.json();
    } catch (err) {
      console.error('Error fetching yesterday prices:', err);
      return {};
    }
  }

  async function fetchLivePrices() {
    const symbols = stocks.map(s => s.symbol);
    const proxyUrl = 'https://corsproxy.io/?';
    try {
      const results = await Promise.all(symbols.map(async symbol => {
        const url = `${proxyUrl}https://nepsetty.kokomo.workers.dev/api/stock?symbol=${symbol}`;
        const res = await fetch(url);
        const data = await res.json();
        return { symbol, price: data.ltp };
      }));
      results.forEach(np => {
        if (np.price != null) {
          const s = stocks.find(x => x.symbol === np.symbol);
          if (s) s.price = +np.price;
        }
      });
      renderStockList();
      const dailyPrices = await fetchYesterdayPrices();
      const metrics = computeMetrics(dailyPrices);
      updateUI(metrics);
      pushChartValue(metrics.todayProfit);
    } catch (err) {
      console.error('Fetch error:', err);
    }
  }

  renderStockList();
  fetchLivePrices();
  setInterval(fetchLivePrices, TICK);

  setInterval(() => {
    const now = new Date().toLocaleTimeString('en-US', { timeZone: 'Asia/Kathmandu' });
    timeEl.textContent = now;
  }, 1000);
</script>
</body>
</html>
